<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote {
    margin: 0;
    padding: 0;
}
body {
    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    color: #737373;
    background-color: white;
    margin: 10px 13px 10px 13px;
}
table {
	margin: 10px 0 15px 0;
	border-collapse: collapse;
}
td,th {	
	border: 1px solid #ddd;
	padding: 3px 10px;
}
th {
	padding: 5px 10px;	
}

a {
    color: #0069d6;
}
a:hover {
    color: #0050a3;
    text-decoration: none;
}
a img {
    border: none;
}
p {
    margin-bottom: 9px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    color: #404040;
    line-height: 36px;
}
h1 {
    margin-bottom: 18px;
    font-size: 30px;
}
h2 {
    font-size: 24px;
}
h3 {
    font-size: 18px;
}
h4 {
    font-size: 16px;
}
h5 {
    font-size: 14px;
}
h6 {
    font-size: 13px;
}
hr {
    margin: 0 0 19px;
    border: 0;
    border-bottom: 1px solid #ccc;
}
blockquote {
    padding: 13px 13px 21px 15px;
    margin-bottom: 18px;
    font-family:georgia,serif;
    font-style: italic;
}
blockquote:before {
    content:"\201C";
    font-size:40px;
    margin-left:-10px;
    font-family:georgia,serif;
    color:#eee;
}
blockquote p {
    font-size: 14px;
    font-weight: 300;
    line-height: 18px;
    margin-bottom: 0;
    font-style: italic;
}
code, pre {
    font-family: Monaco, Andale Mono, Courier New, monospace;
}
code {
    background-color: #fee9cc;
    color: rgba(0, 0, 0, 0.75);
    padding: 1px 3px;
    font-size: 12px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}
pre {
    display: block;
    padding: 14px;
    margin: 0 0 18px;
    line-height: 16px;
    font-size: 11px;
    border: 1px solid #d9d9d9;
    white-space: pre-wrap;
    word-wrap: break-word;
}
pre code {
    background-color: #fff;
    color:#737373;
    font-size: 11px;
    padding: 0;
}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:10px auto;
    }
}
@media print {
	body,code,pre code,h1,h2,h3,h4,h5,h6 {
		color: black;
	}
	table, pre {
		page-break-inside: avoid;
	}
}
</style>
<title>Doppio: Breaking the Browser Language Barrier Artifact Guide</title>

</head>
<body>
<h1>Doppio: Breaking the Browser Language Barrier Artifact Guide</h1>

<p><a href="paper.pdf">Link to the paper.</a></p>

<p>Our artifact consists of two components:</p>

<ul>
<li><strong>DoppioJVM</strong>: A Java Virtual Machine interpreter written in JavaScript that runs on top of the Doppio runtime system, which is also written in JavaScript. It is able to run unmodified JVM bytecode programs in the browser with no plugins required.</li>
<li><strong>Emscripten Demo</strong>: A demo of an Emscripten-compiled game written in C++ using the Doppio file system to persistently store save data to browser-local storage. The game is unchanged; we merely augment the Emscripten environment with the Doppio file system.</li>
</ul>


<p>Below, we provide a guide for each component, and the claims that we are making about each.</p>

<h3>Conflicts of Interest</h3>

<p>We have a conflict of interest with both Daniel Barowy and Charlie Curtsinger on the artifact evaluation committee, as they are both members of the lab that produced this research.</p>

<h3>Offline Version</h3>

<p>You can grab an offline version of this demo by cloning this git repository.</p>

<pre><code>git clone https://github.com/jvilk/doppio-demo
cd doppio-demo
git checkout gh-pages
</code></pre>

<p>The offline version of this demo requires the following software:</p>

<ul>
<li><a href="http://nodejs.org/">NodeJS v0.10</a></li>
<li><code>http-server</code> npm module

<ul>
<li>Install with <code>npm install -g http-server</code> on the command line.</li>
<li>Other HTTP server software may work, but this one is far better than e.g. Python's SimpleHTTPServer or Webrick.</li>
</ul>
</li>
</ul>


<p>To launch the offline version of the demo, merely run <code>http-server</code> in the repository folder and navigate to <a href="http://localhost:8080"><code>http://localhost:8080/</code></a>.</p>

<h2>DoppioJVM artifact guide</h2>

<p>DoppioJVM is a Java Virtual Machine interpreter written in JavaScript that runs on top of the Doppio runtime system, which is also written in JavaScript. It is a proof-of-concept of the Doppio runtime system.</p>

<p>This guide contains useful information on the features available to you through the DoppioJVM demo, and some tips for fun things you can do with it. :)</p>

<p><a href="doppiojvm/index.html">Click here to enter the demo.</a></p>

<h3>DoppioJVM Claims</h3>

<ul>
<li>DoppioJVM can execute <strong>unmodified</strong> JVM bytecode programs in the browser with <em>no plugins or browser modifications required</em>. Instead, it runs on top of the JavaScript engine.</li>
<li>The Doppio runtime system allows DoppioJVM to execute as a series of finite-duration events, allowing long-running programs to function without freezing the browser (§4.1). See the paper for an explanation of the browser's execution model (§3).</li>
<li>The Doppio runtime system allows DoppioJVM to implement synchronous JVM methods using asynchronous browser APIs (§4.2).

<ul>
<li>For example, the following Java code synchronously opens a file for reading:

<ul>
<li><code>FileReader reader = new FileReader(new File("file.txt"));</code></li>
</ul>
</li>
<li>The Doppio runtime system can suspend the JVM, asynchronously fetch the contents of <code>file.txt</code>, and resume the JVM with the file's contents when they become available. The Java program has no idea that this has occurred.</li>
</ul>
</li>
<li>The Doppio runtime system provides DoppioJVM with multithreading capabilities (§4.3). Note that execution is still single-threaded, but we are able to perform context switches at JVM-specified points.

<ul>
<li>We do not claim that we have implemented JVM threads 100% correctly, but they function well enough in our demos.</li>
</ul>
</li>
<li>The Doppio runtime system provides DoppioJVM with extensive file system services (§5.1), including:

<ul>
<li>Access to multiple browser-local storage technologies.</li>
<li>Access to cloud storage (Dropbox).</li>
<li>Access to read-only file downloads provided by the webserver.</li>
<li>(New feature; not in paper) The ability to mount zip files into the file system (used for JAR file support in the demo).</li>
</ul>
</li>
<li>The Doppio runtime system provides DoppioJVM with an emulation of an unmanaged heap, accessible through the <code>sun.misc.Unsafe</code> interface (§5.2).</li>
<li>The Doppio runtime system provides DoppioJVM with TCP socket support (outgoing connections only) using WebSockets (§5.3).</li>
</ul>


<h3>System Requirements</h3>

<p>DoppioJVM has been tested in the latest version of the following desktop browsers:</p>

<ul>
<li>(Recommended) Google Chrome</li>
<li>Firefox</li>
<li>Safari</li>
<li>Internet Explorer 10</li>
<li>Internet Explorer 11</li>
</ul>


<h3>Overview</h3>

<p>The DoppioJVM demo presents a mock terminal interface in the browser for you to work in.</p>

<p>Features:</p>

<ul>
<li>Tab autocomplete for commands and some arguments.</li>
<li>A text editor, accessible via the <code>edit</code> command (don't even try using <code>vim</code> or <code>emacs</code>).</li>
<li>Ability to navigate the file system and perform basic file operations.</li>
<li>Upload files from your hard drive into the current directory using the "Upload Files..." button in the upper-right hand corner.</li>
<li>Command history (use up and down arrows).</li>
<li>Half-baked wildcard expansion (good for one wildcard).</li>
<li>Ability to abort the JVM with CTRL+C.</li>
</ul>


<p>File system locations:</p>

<ul>
<li><code>/sys</code>: (Read-only) Contains the Java Class Library and other system files served up through HTTP.</li>
<li><code>/tmp</code>: (Home directory) Temporary in-memory storage.</li>
<li><code>/jars</code>: Used by the <code>java</code> command to mount JAR files into the file system. Each JAR file passed to it will be mounted to a subdirectory of this directory.</li>
<li><code>/mnt/localStorage</code>: Backed by <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/Storage#localStorage">DOM <code>localStorage</code></a>. Persistently stores 5 to 10MB of data, depending on your browser.</li>
<li><code>/mnt/html5fs</code>: (Chrome and Opera 15+ only) If you accept the prompt below the URL bar, DoppioJVM will mount 50MB of persistent storage using the <a href="https://developer.mozilla.org/en-US/docs/WebGuide/API/File_System">HTML5 FileSystem API</a>.</li>
<li><code>/mnt/dropbox</code>: Read/write to Dropbox cloud storage. Read more under the "Connect to Dropbox" heading below.</li>
</ul>


<p>Shortcomings:</p>

<ul>
<li>No pipes (sorry)</li>
<li>Argument parsing is restrictive (no arguments with spaces, no quoted arguments... we just split on spaces)</li>
</ul>


<h3>Fun Things to Try</h3>

<h4>Compile Java code - in your browser!</h4>

<p>Use the <code>edit</code> command to write a simple Java program, or upload source files through the "Upload Files" button.</p>

<p>Use the <code>javac</code> command to compile your Java files into bytecode. This command invokes an unmodified copy of the Java Compiler from OpenJDK.</p>

<p>Once your files are compiled, use the <code>java</code> command to execute them!</p>

<h4>Upload pre-compiled class files</h4>

<p>Since DoppioJVM operates on JVM bytecodes, you can upload unmodified Java 6 classfiles using the "Upload Files..." button and run them in DoppioJVM. This button will upload the selected files into the current directory. Once uploaded, use the <code>java</code> command to run your files.</p>

<h4>Disassemble class files</h4>

<p>Use the <code>javap</code> command to run an unmodified version of the Java disassembler from OpenJDK using DoppioJVM. You can use this program to view the disassembled bytecode of arbitrary <code>.class</code> files.</p>

<p>Here's an example command:</p>

<p><code>$ javap -classpath /sys -c -private classes.demo.Fib</code></p>

<p>Note that <code>javap</code> doesn't accept <em>files</em> as input, it accepts <em>class names</em>. Thus, <code>javap -c -private /sys/classes/demo/Fib</code> will not work.</p>

<p><code>javap -help</code> will provide you with further options.</p>

<p>We also provide our own bytecode disassembler written in JavaScript, which we use for regression testing. This disassembler is accessible via the <code>disassemble</code> command.</p>

<h4>Upload JAR files, and run them</h4>

<p>Since DoppioJVM is a bytecode interpreter, it can run unmodified JVM programs straight out of JAR files. Please note that DoppioJVM is Java 6 compatible; Java 7 programs will not function on DoppioJVM.</p>

<p>Use the "Upload Files..." button in the upper-right corner to upload a jar file into the current directory, and then use <code>java -jar filehere.jar</code> to run it. You can also use <code>java -classpath filehere.jar class.to.run</code> if you want to execute a different class from the JAR file.</p>

<p>Note that we currently don't process any fields in the JAR file's manifest other than its main class, so if you have a complex manifest that sets JVM system properties and adds classpath items, it may not work correctly.</p>

<h4>Drop into a REPL of a different language</h4>

<p>The DoppioJVM demo ships with two JVM language implementations: An implementation of Scheme using Kawa-Scheme, and an implementation of JavaScript using Rhino (how meta... :) ).</p>

<p>To drop into the Kawa-Scheme repl, use the <code>kawa</code> command. You can also use <code>kawa -f file.sch</code> to execute a Scheme file in the filesystem.</p>

<p>To drop into the Rhino repl, use the <code>rhino</code> command. You can also use <code>rhino -f file.js</code> to execute a JavaScript file in the filesystem.</p>

<p>Use CTRL-D to send an EOF when you are in a repl to exit it.</p>

<h4>Run the benchmarks from the paper</h4>

<p>The paper has four benchmarks, which you can run in the demo. Please note that the second run of each benchmark will be much faster than the first due to file caching, so be sure to throw the first run away. :)</p>

<ul>
<li>To run the Kawa-Scheme benchmark, use the following command:

<ul>
<li><code>time kawa -f /sys/benchmark/kawa/nqueens.sch</code>.</li>
</ul>
</li>
<li>To run the Rhino benchmark, use the following commands (this benchmark automatically runs multiple times):

<ul>
<li><code>cd /sys/benchmark/rhino/</code></li>
<li><code>rhino -f run.js</code>.</li>
<li>Note that there's a <a href="https://github.com/int3/doppio/issues/185">Rhino bug</a> where the output of this program is missing newlines. This is an issue with the version of Rhino bundled with our Java Class Library. The non-bundled version, which the native benchmark runner uses, does not have this bug.</li>
</ul>
</li>
<li>To run the <code>javap</code> benchmark, run <code>time javap_benchmark</code>.

<ul>
<li>Note that we disable printing to the console during this benchmark. This is intentional.</li>
</ul>
</li>
<li>To run the <code>javac</code> benchmark, run <code>time javac_benchmark</code>.</li>
</ul>


<p>If you wish to compare performance to the Java interpreter like we do in the paper, there is a simple shell script in the <code>doppiojvm</code> directory that can run the benchmarks. Note that this will use your native Java installation. In our paper, we compared against an installation of Java 6.</p>

<p><code>Usage: ./run-benchmark.sh [kawa|rhino|javap|javac]</code></p>

<h4>Mess around with sockets</h4>

<p>DoppioJVM emulates Java's TCP sockets in terms of WebSockets. As a demonstration, we provide a simple TCP server and client with this demo. Here are instructions on how to use it.</p>

<p>Note that you should use the offline DoppioJVM package for this to avoid port forwarding snafus.</p>

<ul>
<li>Download and extract <a href="https://github.com/kanaka/websockify/archive/v0.5.1.zip">Websockify</a> to your computer.</li>
<li>In the command prompt, enter the <code>websockify-0.5.1</code> directory and type <code>make</code>.</li>
<li>Run:

<ul>
<li><code>./websockify.py 6789 localhost:6790</code></li>
<li>(This accepts WebSocket connections on port 6789, and proxies them over a local TCP socket on port 6790)</li>
</ul>
</li>
<li>In the <code>doppiojvm</code> demo directory, run <code>java classes.demo.TCPServer</code></li>
<li>On the demo webpage, run <code>java -cp /sys classes.demo.TCPClient</code></li>
<li>Type something in, and press enter. The server will send it back in all caps, the client will print the response, and then the client will exit.</li>
</ul>


<p>The source code to both programs are in the <code>classes/demo</code> directory.</p>

<p>Known bug:</p>

<ul>
<li>Sometimes, the client will print <code>null</code> and exit. This is due to an interesting <code>SocketInputStream</code> behavior; if the socket does not receive data before a specified timeout, <code>SocketInputReader</code> assumes that it received an EOF. <a href="http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/java/net/SocketInputStream.java#146">Here's the code -- look what happens when <code>socketRead0</code> returns 0.</a> :(</li>
</ul>


<h4>Store files for later</h4>

<p>Any files stored in <code>/mnt/localStorage</code> or <code>/mnt/html5fs</code> (the latter is only available in Chrome and Opera 15+) will persist in browser-local storage across visits to the demo page. Go ahead and stash some files in there, close the browser, and navigate back to the demo.</p>

<h4>Connect to Dropbox</h4>

<p>Doppio's filesystem supports Dropbox cloud storage accounts. Use the <code>mount_dropbox</code> command for more information. Note that you will need to use this command a second time after you have logged in to complete the mounting process.</p>

<p>Please note that using this feature will <em>not</em> reveal your identity to the artifact authors. The artifact authors can see the <strong>number</strong> of users that have used our API key to connect to Dropbox, but not their <strong>identity</strong>.</p>

<p>If you would like, you can use your own API key; development keys are free. You must sign up for one at the <a href="https://www.dropbox.com/developers/apps">Dropbox Application Console</a>. Make sure you add the appropriate OAuth Redirect URI (<code>http://localhost:8080/doppiojvm/index.html</code> for a locally-served demo). Use the <code>mount_dropbox</code> command with no arguments for syntax information.</p>

<p>Once you've connected to Dropbox, navigate to <code>/mnt/dropbox</code>. Feel free to create files using the <code>edit</code> command, and watch as your native Dropbox client syncs them to your local computer. Or, pop files into the <code>Apps/DoppioJVM</code> Dropbox folder, and use <code>ls</code> to see them in the DoppioJVM terminal. Note that sometimes Dropbox is slow to sync; check Dropbox's syncing progress in your system tray.</p>

<p>You could even pop some JAR files into the directory and run them in DoppioJVM. Or write+run a Java program to generate files in the directory.</p>

<h4>Interoperate Java with JavaScript</h4>

<p>Here's a fun little program that takes advantage of DoppioJVM's JavaScript API:</p>

<pre><code>import java.io.*;
import classes.doppio.JavaScript;

class JavaScriptREPL {
  public static void main(String argv[]) throws Exception {
    String sentence;
    BufferedReader fromUser = new BufferedReader(new InputStreamReader(System.in));
    while(true) {
      sentence = fromUser.readLine();
      if (sentence.length() == 0) {
          break;
      }
      System.out.println(JavaScript.eval(sentence));
    }
  }
}
</code></pre>

<p>Compile this with <code>javac -cp /sys JavaScriptREPL.java</code>, since the <code>.class</code> file for the <code>doppio</code> API is in the <code>/sys</code> folder.</p>

<p>Run the REPL with <code>java -cp /sys:. JavaScriptREPL</code>.</p>

<p>Another fun thing you could do: Write a helper function that uses <code>eval</code> to evaluate a JavaScript expression, and return a JSON object. You can use one of the <a href="http://json.org/java/">many Java JSON parsers available</a> to convert the String returned from <code>eval</code> into a proper Java object.</p>

<h3>Caveats</h3>

<p>Of course, DoppioJVM isn't perfect. Here are some issues you might run into, especially if you are trying new code:</p>

<ul>
<li><strong>Java 7 is not supported</strong>. DoppioJVM is a Java 6 JVM. Attempting to run a Java 7 program will likely result in interesting errors.</li>
<li><strong><code>java/lang/UnsatisfiedLinkError</code></strong>: The Java Class Library has <em>many</em> <code>native</code> methods that are written in C/C++. <a href="https://github.com/int3/doppio/blob/master/src/natives.ts">DoppioJVM implements quite a few of them in JavaScript</a>, but there are many that we might have missed.</li>
<li><strong>DoppioJVM hangs or appears to be doing nothing.</strong> There are many potential causes of this:

<ul>
<li><strong>Cloud storage</strong>: Reading files from Dropbox is slow.</li>
<li><strong>Remote file downloads</strong>: On the online version of the DoppioJVM demo, the first time each class from the Java Class Library is loaded, DoppioJVM must issue a remote HTTP file download. Check the network tab of your browser's JavaScript debug tools to see if many class files are whizzing by.</li>
<li><strong>DoppioJVM bug</strong>: Bugs happen. Check the JavaScript console in your browser to see if there are any uncaught exceptions.</li>
</ul>
</li>
<li><strong>DoppioJVM crashed the browser.</strong> Some potential causes of this are:

<ul>
<li>This might happen if you run a program with a long-running loop that makes no function calls. As we mention in the paper, DoppioJVM only performs a suspend-and-resume check at function call boundaries. We have not encountered programs like this in practice.</li>
<li>Opening or interacting with the browser's developer tools while DoppioJVM is running tends to crash the browser. This is especially true of the debug/source code panel.</li>
</ul>
</li>
<li><strong>The official Kawa-Scheme JAR file does not work.</strong> Full disclosure: We needed to make a trivial edit to Kawa-Scheme to run it on DoppioJVM, as it makes <a href="https://github.com/int3/doppio/issues/164#issuecomment-15264211">an illegal assumption about the bootstrap ClassLoader</a> that happens to be true for the HotSpot JVM. Thus, the official JAR file will not function in DoppioJVM. We offer our patched version <a href="https://docs.google.com/file/d/0BzhBeckwqxilcDZSendxT2NVYjQ/edit?usp=sharing">here</a>.</li>
<li><strong>I can no longer type commands into the terminal.</strong> Rarely, an unexpected error can cause the demo page to lose the callback that restores your access to the terminal. You'll have to reload the page.</li>
<li><strong>The first run of a program is significantly slower than the second.</strong> This is caused by DoppioJVM's current file system setup. Instead of using compressed JAR files for the Java Class Library and our benchmark applications, we use individual class files. Each time DoppioJVM's classloader loads a classfile from the <code>/sys</code> folder, it must fetch the class file's contents from the remote server. The file system will cache the file's contents, so subsequent fetches on the second run will be instantaneous.</li>
</ul>


<h3>Reporting Bugs</h3>

<p>While reviewers have a need to stay anonymous, it would be nice if you could somehow anonymously funnel any bugs you find to our <a href="https://github.com/int3/doppio/issues">GitHub issue tracker</a>. You can also contact the authors directly. Thanks!</p>

<h2>Emscripten Demo artifact guide</h2>

<p>The Emscripten demo (in the <code>emscripten</code> subdirectory of the demo folder) demonstrates the following:</p>

<ul>
<li>A C++ application that has been ported to Emscripten is able to use the Doppio file system without any changes.</li>
<li>The Doppio file system integrates seamlessly into the Emscripten environment.</li>
<li>Using the Doppio file system, Emscripten does not need to preload the entire file system into memory prior to execution. Instead, it is able to load files as the application requests them.</li>
</ul>


<p>§2.1 explains some of the limitations of Emscripten's approach to bringing C++ applications to the web, and §7.2 explains this evaluation.</p>

<p>The C++ application in question is an Emscripten port of the open source game <a href="http://meandmyshadow.sourceforge.net/">Me and My Shadow</a>.</p>

<h3>Vanilla Emscripten Verison</h3>

<p>The original Emscripten port can be played <a href="emscripten/mams/mams.html">here</a>.</p>

<p>Things to do:</p>

<ul>
<li>Note that Emscripten preloads all of the games assets prior to starting it.</li>
<li>Complete a level by guiding the character to the door using the arrow keys.</li>
<li>Use ESC to go back to the level selection screen.</li>
<li>Note that your progress has not been saved at all. You must start again at the first level.</li>
</ul>


<h3>Emscripten+Doppio Version</h3>

<p>Now, try our version that embeds Doppio's file system into Emscripten's file system. You can access this <a href="emscripten/mams-doppio/mams.html">here</a>.</p>

<p>Things to do:</p>

<ul>
<li>Note that we do not preload all game assets at once; instead, we download them as the game requests them.

<ul>
<li>This does not increase the <em>responsiveness</em> of the game as it can cause unwanted pauses during gameplay, but it reduces startup time and prevents the developer from needing to explicitly bundle files together.</li>
</ul>
</li>
<li>Complete a level by guiding the character to the door using the arrow keys.</li>
<li>Use ESC to go back to the level selection screen.</li>
<li>Note that your progress is saved!</li>
<li>Close the web browser.</li>
<li>Open the web browser, and navigate back to the web page.</li>
<li>Go back to the level selection screen. Note that your progress is still saved. :)</li>
</ul>


<h3>Caveats</h3>

<p>In both versions, the "Addons" and "Map Editor" menu items do not function. The first is likely an Emscripten bug. The latter is due to the program attempting to synchronously poll for input. Unlike DoppioJVM, Emscripten cannot emulate synchronous C++ features in terms of asynchronous browser functionality (§2.1). And since the browser has only asynchronous APIs for processing input*, this feature of "Me and My Shadow" will remain unsupported in Emscripten until someone refactors the code to use asynchronous C++ APIs.</p>

<p>* <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window.prompt"><code>window.prompt</code></a> is the one exception.</p>
</body>
</html>
